"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("setimmediate");var l=require("@ceramicnetwork/stream-tile"),c=require("@ceramicnetwork/streamid"),_=require("dataloader");function g(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var y=g(_),m=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},h=(e,t,r)=>(m(e,t,"read from private field"),r?r.call(e):t.get(e)),f=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},p=(e,t,r,a)=>(m(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r),o,u;function v(e){return typeof e=="string"||c.CommitID.isInstance(e)||c.StreamID.isInstance(e)?{streamId:e}:{streamId:e.streamId,genesis:e.genesis}}function d(e){return typeof e=="string"?c.StreamRef.from(e).toString():c.CommitID.isInstance(e)||c.StreamID.isInstance(e)?e.toString():e.streamId.toString()}async function w(e){const t=await l.TileDocument.makeGenesis({},null,{...e,deterministic:!0}),r=await c.StreamID.fromGenesis("tile",t);return{genesis:t,streamId:r}}const I=()=>Promise.resolve([]);class D extends y.default{constructor(t){super(I,{cache:!0,cacheKeyFn:d,cacheMap:t.cache!=null&&typeof t.cache!="boolean"?t.cache:void 0});f(this,o,void 0),f(this,u,void 0),this._batchLoadFn=async r=>{t.cache||this.clearAll();const a=await t.ceramic.multiQuery(r.map(v));return r.map(n=>{const i=d(n),s=a[i];return s||new Error(`Failed to load stream: ${i}`)})},p(this,o,t.ceramic),p(this,u,!!t.cache)}cache(t){if(!h(this,u))return!1;const r=t.id.toString();return this.clear(r).prime(r,t),!0}async create(t,r,a){const n=await l.TileDocument.create(h(this,o),t,r,a);return this.cache(n),n}async deterministic(t,r){const a=await w(t);try{return await super.load(a)}catch{const i=await l.TileDocument.createFromGenesis(h(this,o),a.genesis,r);return this.cache(i),i}}async load(t){return await super.load(t)}async update(t,r,a,n){const i=d(t);this.clear(i);const s=await this.load({streamId:i});return await s.update(r,a,n),s}}o=new WeakMap,u=new WeakMap,exports.TileLoader=D,exports.getDeterministicQuery=w,exports.keyToQuery=v,exports.keyToString=d;
//# sourceMappingURL=lib.cjs.map
